name: RSS to Discord

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

concurrency:
  group: rss-check
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install rss-parser discord-webhook-node

    - name: Run RSS checker
      run: node main.js
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    - name: Commit and push changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Nettoyer les fichiers modifiés par npm install
        # pour que git pull --rebase fonctionne proprement
        git checkout -- node_modules/ 2>/dev/null || true
        git checkout -- package-lock.json 2>/dev/null || true
        
        git add last_posts.json
        
        if git diff --staged --quiet; then
          echo "Pas de changement dans last_posts.json"
          exit 0
        fi
        
        git commit -m "Update last_posts.json [AUTO]"
        
        MAX_RETRIES=3
        for i in $(seq 1 $MAX_RETRIES); do
          if git push origin main; then
            echo "Push réussi"
            exit 0
          fi
          echo "Push échoué (tentative $i/$MAX_RETRIES), pull et retry..."
          # Nettoyer à nouveau avant le rebase
          git checkout -- node_modules/ 2>/dev/null || true
          git checkout -- package-lock.json 2>/dev/null || true
          git pull --rebase origin main
        done
        
        echo "ERREUR: Push impossible après $MAX_RETRIES tentatives"
        exit 1
